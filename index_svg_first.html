<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bihar Assembly Constituencies — SVG Viewer</title>
  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, Arial, sans-serif; }
    #controls { padding: 10px 12px; display:flex; gap:10px; align-items:center; flex-wrap: wrap; }
    #mapwrap { height: calc(100vh - 70px); }
    #status { color: #b00; margin-left: 8px; }
    svg { width: 100%; height: 100%; background: #f9fafb; display:block; }
    .ac { fill: #cfe3f6; stroke: #1f77b4; stroke-width: 0.5; }
    .ac:hover { fill: #a9d0ff; cursor: pointer; }
    .selected { fill: #f7c6c6; stroke: #d62728; stroke-width: 1.2; }
    #info { font-size: 0.95rem; }
    
    .label { font: 12px/1.1 sans-serif; fill: #111; paint-order: stroke; stroke: #fff; stroke-width: 3px; stroke-linejoin: round; }
  </style>
</head>
<body>
  <div id="controls">
    <strong>Bihar Assembly (SVG)</strong>
    <label for="acSelect">Constituency:</label>
    <select id="acSelect"><option value="">- Select -</option></select>
    <button id="zoomOut" type="button" title="Zoom out">−</button>
    <button id="zoomIn" type="button" title="Zoom in">+</button>
    <button id="exportSel" type="button" disabled>Export Selected SVG</button>
    <button id="exportAll" type="button">Export All SVG</button>
    <span id="status"></span>
    <div id="info"></div>
  </div>
  <div id="mapwrap" class="loading">
    <svg id="svg" viewBox="0 0 1200 900" preserveAspectRatio="xMidYMid meet">
      <g id="zoomlayer"></g>
      <g id="uiLayer"></g>
    </svg>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>
  <script>
    const width = 1200, height = 900;
    const svg = d3.select('#svg');
    const g = d3.select('#zoomlayer');
    const ui = d3.select('#uiLayer');
    const labelLayer = g.append('g').attr('id','labelLayer');
    const statusEl = document.getElementById('status');
    const infoEl = document.getElementById('info');
    const selEl = document.getElementById('acSelect');
    const wrapEl = document.getElementById('mapwrap');

    let biharData = null;
    let projection, path;
    let selectedId = null;

    const zoom = d3.zoom().scaleExtent([1, 20]).on('zoom', (ev) => {
      g.attr('transform', ev.transform);
      updateCrossButton();
    });
    svg.call(zoom);

    function setInfo(html){ infoEl.innerHTML = html || ''; }

    function createCrossButton(){
      const crossButton = ui.append('g')
        .attr('class', 'cross-button')
        .attr('transform', `translate(${width - 30}, 30)`)
        .style('cursor', 'pointer')
        .style('display', 'none');

      crossButton.append('circle')
        .attr('r', 15)
        .attr('fill', 'white')
        .attr('stroke', '#666')
        .attr('stroke-width', 1);

      crossButton.append('path')
        .attr('d', 'M-6,-6 L6,6 M6,-6 L-6,6')
        .attr('stroke', '#333')
        .attr('stroke-width', 2);

      crossButton.on('click', clearAndReset);
    }

    function updateCrossButton(){
      const transform = d3.zoomTransform(svg.node());
      const isZoomed = transform.k > 1.01;
      const isSelected = selectedId !== null;

      ui.select('.cross-button')
        .style('display', (isZoomed || isSelected) ? 'block' : 'none');
    }

    function featureKey(p){
      const n = p.AC_NO ?? p.ac_no ?? p.Ac_No;
      try { return String(parseInt(+n)).padStart(3,'0'); } catch { return String(n||''); }
    }

    function populateSelect(features){
      const items = features.map(f => ({
        key: featureKey(f.properties),
        name: f.properties.AC_NAME || f.properties.ac_name || f.properties.Ac_Name || 'AC',
        dist: f.properties.DIST_NAME || f.properties.dist_name || '',
        pcno: f.properties.PC_NO || f.properties.pc_no || '',
        pcname: f.properties.PC_NAME || f.properties.pc_name || ''
      })).sort((a,b) => a.key.localeCompare(b.key));
      for(const it of items){
        const opt = document.createElement('option');
        opt.value = it.key;
        opt.textContent = `${it.key} - ${it.name}${it.dist? ' ('+it.dist+')':''}`;
        opt.dataset.acname = it.name;
        opt.dataset.district = it.dist;
        opt.dataset.pcno = it.pcno;
        opt.dataset.pcname = it.pcname;
        selEl.appendChild(opt);
      }
    }

    function draw(features){
      g.selectAll('path').data(features)
        .join('path')
        .attr('class', 'ac')
        .attr('data-key', d => featureKey(d.properties))
        .attr('d', d => path(d))
        .on('click', (ev, d) => selectByKey(featureKey(d.properties)));
    }

    function fitToFeature(f){
      const b = path.bounds(f);
      const dx = b[1][0] - b[0][0];
      const dy = b[1][1] - b[0][1];
      const cx = (b[0][0] + b[1][0]) / 2;
      const cy = (b[0][1] + b[1][1]) / 2;
      const scale = Math.max(1, 0.9 / Math.max(dx / width, dy / height));
      const transform = d3.zoomIdentity.translate(width/2, height/2).scale(scale).translate(-cx, -cy);
      svg.transition().duration(750).call(zoom.transform, transform);
    }

    function clearAndReset(){
      selectedId = null;
      g.selectAll('path').classed('selected', false);
      selEl.value = '';
      document.getElementById('exportSel').disabled = true;
      setInfo('');
      labelLayer.selectAll('*').remove();
      // Reset zoom
      svg.transition().duration(400).call(zoom.transform, d3.zoomIdentity);
      updateCrossButton();
    }

    function selectByKey(key){
      selectedId = key;
      g.selectAll('path').classed('selected', d => featureKey(d.properties) === key);
      g.selectAll('path').filter(d => featureKey(d.properties) === key).raise();
      const f = biharData.features.find(ft => featureKey(ft.properties) === key);
      if(f){
        fitToFeature(f);
        const p = f.properties;
        const acno = key;
        const acname = p.AC_NAME || p.ac_name || p.Ac_Name || '';
        const dist = p.DIST_NAME || p.dist_name || '';
        const pcno = p.PC_NO || p.pc_no || '';
        const pcname = p.PC_NAME || p.pc_name || '';
        setInfo(`<b>${acno} ${acname}</b>${dist? ' · District: '+dist:''}${pcname? ' · PC: '+pcno+' '+pcname:''}`);
        document.getElementById('exportSel').disabled = false;
        // Add center label for selection
        try {
          const c = path.centroid(f);
          labelLayer.raise();
          labelLayer.selectAll('text.sel')
            .data([f])
            .join('text')
            .attr('class','label sel')
            .attr('x', c[0])
            .attr('y', c[1])
            .attr('text-anchor','middle')
            .text(acno + ' ' + acname);
        } catch(e) { console.error('label error', e); }
      }
      updateCrossButton();
    }

    selEl.addEventListener('change', () => {
      if(selEl.value){ selectByKey(selEl.value); } else { clearAndReset(); }
    });

    function exportAllSvg(){
      if(!biharData) return;
      const w = 1200, h = 1200;
      const proj = d3.geoMercator().fitSize([w,h], biharData);
      const pth = d3.geoPath(proj);
      const ns = 'http://www.w3.org/2000/svg';
      const svgEl = document.createElementNS(ns, 'svg');
      svgEl.setAttribute('xmlns', ns); svgEl.setAttribute('width', w); svgEl.setAttribute('height', h);
      svgEl.setAttribute('viewBox', `0 0 ${w} ${h}`);
      const gEl = document.createElementNS(ns, 'g'); svgEl.appendChild(gEl);
      for(const f of biharData.features){
        const pathEl = document.createElementNS(ns, 'path');
        pathEl.setAttribute('d', pth(f));
        pathEl.setAttribute('fill', 'none');
        pathEl.setAttribute('stroke', '#1f77b4');
        pathEl.setAttribute('stroke-width', '0.8');
        gEl.appendChild(pathEl);
      }
      const xml = new XMLSerializer().serializeToString(svgEl);
      const blob = new Blob([xml], {type:'image/svg+xml;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'bihar_ac.svg';
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
      setTimeout(()=>URL.revokeObjectURL(url), 1000);
    }

    function exportSelectedSvg(){
      if(!selectedId || !biharData) return;
      const f = biharData.features.find(ft => featureKey(ft.properties) === selectedId);
      if(!f) return;
      const w = 800, h = 800;
      const proj = d3.geoMercator().fitSize([w,h], f);
      const pth = d3.geoPath(proj);
      const ns = 'http://www.w3.org/2000/svg';
      const svgEl = document.createElementNS(ns, 'svg');
      svgEl.setAttribute('xmlns', ns); svgEl.setAttribute('width', w); svgEl.setAttribute('height', h);
      svgEl.setAttribute('viewBox', `0 0 ${w} ${h}`);
      const gEl = document.createElementNS(ns, 'g'); svgEl.appendChild(gEl);
      const pathEl = document.createElementNS(ns, 'path');
      pathEl.setAttribute('d', pth(f));
      pathEl.setAttribute('fill', '#f7c6c6');
      pathEl.setAttribute('stroke', '#d62728');
      pathEl.setAttribute('stroke-width', '1');
      gEl.appendChild(pathEl);
      const p = f.properties;
      const acno = featureKey(p);
      const acname = p.AC_NAME || p.ac_name || p.Ac_Name || 'ac';
      const xml = new XMLSerializer().serializeToString(svgEl);
      const blob = new Blob([xml], {type:'image/svg+xml;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = `bihar_ac_${acno}_${acname.replace(/[^A-Za-z0-9]+/g,'_').toLowerCase()}.svg`;
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
      setTimeout(()=>URL.revokeObjectURL(url), 1000);
    }

    document.getElementById('exportAll').addEventListener('click', exportAllSvg);
    document.getElementById('exportSel').addEventListener('click', exportSelectedSvg);

    async function init(){
      try{
        statusEl.textContent = 'Loading Bihar GeoJSON...';
        const data = await fetch('bihar_ac_all.geojson').then(r => r.json());
        biharData = data;
        projection = d3.geoMercator().fitSize([width, height], biharData);
        path = d3.geoPath(projection);
        draw(biharData.features);
        populateSelect(biharData.features);
        createCrossButton();
        wrapEl.classList.remove('loading');
        statusEl.textContent = '';
      }catch(e){
        console.error(e);
        statusEl.textContent = 'Failed to load Bihar GeoJSON';
      }
    }

    document.getElementById('zoomIn').addEventListener('click', zoomIn);
    document.getElementById('zoomOut').addEventListener('click', zoomOut);

    function zoomIn(){ svg.transition().duration(300).call(zoom.scaleBy, 1.3); }
    function zoomOut(){ svg.transition().duration(300).call(zoom.scaleBy, 1/1.3); }
    init();
  </script>
</body>
</html>





