<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bihar Assembly Constituencies — SVG Choropleth</title>
  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, Arial, sans-serif; }
    #controls { padding: 10px 12px; display:flex; gap:10px; align-items:center; flex-wrap: wrap; }
    #mapwrap { height: calc(100vh - 80px); }
    #status { color: #b00; margin-left: 8px; }
    svg { width: 100%; height: 100%; background: #f9fafb; display:block; }
    .ac { stroke: #1f77b4; stroke-width: 0.5; }
    .ac:hover { stroke-width: 0.8; cursor: pointer; }
    .selected { stroke: #d62728; stroke-width: 1.2; }
    #info { font-size: 0.95rem; }
    .label { font: 12px/1.1 sans-serif; fill: #111; paint-order: stroke; stroke: #fff; stroke-width: 3px; stroke-linejoin: round; }
    .legend { display:flex; align-items:center; gap:8px; }
    .legend .swatch { width:14px; height:14px; border:1px solid #999; }
    .tooltip { position: fixed; pointer-events: none; background: rgba(255,255,255,0.95); border: 1px solid #ccc; border-radius: 4px; padding: 6px 8px; font-size: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.2); display:none; }
  </style>
</head>
<body>
  <div id="controls">
    <strong>Bihar Assembly (SVG)</strong>
    <label for="acSelect">Constituency:</label>
    <select id="acSelect"><option value="">- Select -</option></select>
    <button id="clearSel" type="button">Clear</button>
    <button id="zoomOut" type="button" title="Zoom out">-</button>
    <button id="zoomIn" type="button" title="Zoom in">+</button>
    <button id="resetView" type="button" title="Reset view">Reset</button>
    <label for="metricSelect">Color by:</label>
    <select id="metricSelect">
      <option value="alliance" selected>Alliance (current)</option>
      <option value="margin20">Margin (2020)</option>
    </select>
    <span id="legend" class="legend"></span>
    <span id="status"></span>
    <div id="info"></div>
  </div>
  <div id="mapwrap" class="loading">
    <svg id="svg" viewBox="0 0 1200 900" preserveAspectRatio="xMidYMid meet">
      <g id="zoomlayer"></g>
    </svg>
  </div>
  <div id="tooltip" class="tooltip"></div>

  <script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>
  <script>
    const width = 1200, height = 900;
    const svg = d3.select('#svg');
    const g = d3.select('#zoomlayer');
    const labelLayer = g.append('g').attr('id','labelLayer');
    const statusEl = document.getElementById('status');
    const infoEl = document.getElementById('info');
    const selEl = document.getElementById('acSelect');
    const wrapEl = document.getElementById('mapwrap');
    const tooltip = document.getElementById('tooltip');

    let biharData = null;
    let projection, path;
    let selectedId = null;
    let dataMap = new Map();
    let currentMetric = 'alliance';

    const allianceColors = new Map(Object.entries({ NDA: '#1f77b4', MGB: '#d62728', UPA: '#9467bd', OTH: '#8c564b', IND: '#7f7f7f' }));
    const marginScale = d3.scaleThreshold().domain([2000,5000,10000,20000,40000]).range(['#f2f0f7','#dadaeb','#bcbddc','#9e9ac8','#756bb1','#54278f']);

    const zoom = d3.zoom().scaleExtent([1, 20]).on('zoom', (ev) => { g.attr('transform', ev.transform); });
    svg.call(zoom);

    function featureKey(p){
      const n = p.AC_NO ?? p.ac_no ?? p.Ac_No; try { return String(parseInt(+n)).padStart(3,'0'); } catch { return String(n||''); }
    }
    function keyPad(n){ try { return String(parseInt(+n)).padStart(3,'0'); } catch { return String(n||''); } }
    function num(x){ if(x==null) return null; const s=String(x).replace(/,/g,'').trim(); const v=+s; return isFinite(v)?v:null; }

    function setInfo(html){ infoEl.innerHTML = html || ''; }

    function colorForFeature(f){
      const k = featureKey(f.properties); const row = dataMap.get(k);
      if(!row) return '#cfe3f6';
      if(currentMetric==='alliance'){
        const a = (row.current_mla_alliance || '').toUpperCase(); return allianceColors.get(a) || '#cccccc';
      } else if(currentMetric==='margin20'){
        const m = num(row.y2020_margin); return m==null ? '#eeeeee' : marginScale(m);
      }
      return '#cfe3f6';
    }

    function populateSelect(features){
      const items = features.map(f => ({
        key: featureKey(f.properties),
        name: f.properties.AC_NAME || f.properties.ac_name || f.properties.Ac_Name || 'AC',
        dist: f.properties.DIST_NAME || f.properties.dist_name || ''
      })).sort((a,b) => a.key.localeCompare(b.key));
      for(const it of items){
        const opt = document.createElement('option');
        opt.value = it.key; opt.textContent = `${it.key} - ${it.name}${it.dist? ' ('+it.dist+')':''}`;
        selEl.appendChild(opt);
      }
    }

    function draw(features){
      g.selectAll('path').data(features)
        .join('path')
        .attr('class', 'ac')
        .attr('data-key', d => featureKey(d.properties))
        .attr('d', d => path(d))
        .attr('fill', d => colorForFeature(d))
        .on('mousemove', (ev,d)=> showTooltip(ev,d))
        .on('mouseleave', hideTooltip)
        .on('click', (ev, d) => selectByKey(featureKey(d.properties)));
    }

    function fitToFeature(f){
      const b = path.bounds(f); const dx = b[1][0]-b[0][0]; const dy = b[1][1]-b[0][1];
      const cx=(b[0][0]+b[1][0])/2, cy=(b[0][1]+b[1][1])/2; const scale=Math.max(1, 0.9/Math.max(dx/width, dy/height));
      const transform = d3.zoomIdentity.translate(width/2, height/2).scale(scale).translate(-cx, -cy);
      svg.transition().duration(750).call(zoom.transform, transform);
    }

    function clearSelection(){
      selectedId = null; g.selectAll('path').classed('selected', false); selEl.value = '';
      setInfo(''); labelLayer.selectAll('*').remove(); hideTooltip();
    }

    function selectByKey(key){
      selectedId = key; g.selectAll('path').classed('selected', d => featureKey(d.properties) === key);
      g.selectAll('path').filter(d => featureKey(d.properties) === key).raise();
      const f = biharData.features.find(ft => featureKey(ft.properties) === key);
      if(f){
        fitToFeature(f);
        const p = f.properties; const acname = p.AC_NAME || p.ac_name || p.Ac_Name || ''; const dist = p.DIST_NAME || p.dist_name || '';
        setInfo(`<b>${key} ${acname}</b>${dist? ' · District: '+dist:''}`);
        try {
          const c = path.centroid(f); labelLayer.raise();
          const label = labelLayer.selectAll('text.sel').data([f]).join('text').attr('class','label sel')
            .attr('x', c[0]).attr('y', c[1]).attr('text-anchor','middle').text(key + ' ' + acname);
        } catch(e) { console.error('label error', e); }
      }
    }

    function showTooltip(ev, d){
      const p = d.properties || {}; const k = featureKey(p); const row = dataMap.get(k) || {}; const name = p.AC_NAME || p.ac_name || p.Ac_Name || ''; const dist = p.DIST_NAME || p.dist_name || '';
      let val = ''; if(currentMetric==='alliance') val = `Alliance: ${row.current_mla_alliance || ''}`; else if(currentMetric==='margin20') val = `2020 margin: ${row.y2020_margin || ''}`;
      tooltip.innerHTML = `<b>${k} ${name}</b>${dist? ' · '+dist:''}<br>${val}`; tooltip.style.display='block'; tooltip.style.left=(ev.clientX+12)+'px'; tooltip.style.top=(ev.clientY+12)+'px';
    }
    function hideTooltip(){ tooltip.style.display='none'; }

    function updateLegend(){
      const el = document.getElementById('legend'); el.innerHTML='';
      if(currentMetric==='alliance'){
        for(const [lab,col] of allianceColors){ const box=document.createElement('span'); box.className='swatch'; box.style.background=col; const t=document.createElement('span'); t.textContent=lab; t.style.marginRight='8px'; el.appendChild(box); el.appendChild(t);}      }
      else { const dom=marginScale.domain(), rng=marginScale.range(); for(let i=0;i<rng.length;i++){ const box=document.createElement('span'); box.className='swatch'; box.style.background=rng[i]; const from=i===0?0:dom[i-1]; const to=dom[i]||'+'; const t=document.createElement('span'); t.textContent=`${from}–${to}${to==='+'?'':''}`; t.style.marginRight='8px'; el.appendChild(box); el.appendChild(t);} }
    }

    function recolor(){ g.selectAll('path.ac').attr('fill', d => colorForFeature(d)); }

    document.getElementById('metricSelect').addEventListener('change', (e)=>{ currentMetric = e.target.value; updateLegend(); recolor(); hideTooltip(); });
    selEl.addEventListener('change', () => { if(selEl.value){ selectByKey(selEl.value); } else { clearSelection(); } });
    document.getElementById('clearSel').addEventListener('click', clearSelection);

    document.getElementById('zoomIn').addEventListener('click', ()=> svg.transition().duration(300).call(zoom.scaleBy, 1.3));
    document.getElementById('zoomOut').addEventListener('click', ()=> svg.transition().duration(300).call(zoom.scaleBy, 1/1.3));
    document.getElementById('resetView').addEventListener('click', ()=> svg.transition().duration(400).call(zoom.transform, d3.zoomIdentity));

    async function init(){
      try{
        statusEl.textContent = 'Loading Bihar GeoJSON...';
        const data = await fetch('bihar_ac_all.geojson').then(r => r.json());
        biharData = data; projection = d3.geoMercator().fitSize([width, height], biharData); path = d3.geoPath(projection);
        draw(biharData.features); populateSelect(biharData.features); wrapEl.classList.remove('loading'); statusEl.textContent='';
        try{ const rows = await d3.csv('bihar_election_results_consolidated.csv'); dataMap = new Map(rows.map(r => [ keyPad(r.no), r ])); updateLegend(); recolor(); } catch(e){ console.warn('CSV load failed', e); }
      }catch(e){ console.error(e); statusEl.textContent = 'Failed to load Bihar GeoJSON'; }
    }

    init();
  </script>
</body>
</html>
