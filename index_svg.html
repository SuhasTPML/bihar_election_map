<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bihar Assembly Constituencies — SVG Choropleth</title>
  <style>
    :root {
      --primary: #2563eb;
      --primary-hover: #1d4ed8;
      --secondary: #64748b;
      --accent: #f59e0b;
      --success: #10b981;
      --warning: #f59e0b;
      --error: #ef4444;
      --background: #ffffff;
      --surface: #f8fafc;
      --surface-elevated: #ffffff;
      --border: #e2e8f0;
      --border-light: #f1f5f9;
      --text-primary: #0f172a;
      --text-secondary: #475569;
      --text-muted: #64748b;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
      --radius: 8px;
      --radius-sm: 4px;
      --transition: all 0.2s ease;
      --touch-target: 44px;
      --z-floating: 1000;
      --z-modal: 2000;
    }
    
    * { box-sizing: border-box; }
    
    html, body {
      height: 100%;
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--surface);
      color: var(--text-primary);
      line-height: 1.6;
    }
    
    #controls {
      padding: 12px 16px;
      background: var(--surface-elevated);
      border-bottom: 1px solid var(--border-light);
      box-shadow: var(--shadow-sm);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    .search-container {
      position: relative;
      width: 100%;
      max-width: 100%;
    }
    
    .search-input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid var(--border);
      border-radius: var(--radius);
      font-size: 16px;
      background: var(--surface-elevated);
      transition: var(--transition);
      -webkit-appearance: none;
      appearance: none;
    }
    
    .search-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    
    .search-input::placeholder {
      color: var(--text-muted);
    }
    
    .controls-secondary {
      display: none;
      gap: 12px;
      margin-top: 12px;
      flex-wrap: wrap;
      align-items: center;
    }
    
    .control-group {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.875rem;
    }
    
    .control-select {
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: var(--surface-elevated);
      font-size: 0.875rem;
      min-width: 120px;
    }
    
    .toggle-controls {
      margin-top: 8px;
      padding: 8px 0;
      color: var(--primary);
      font-size: 0.875rem;
      cursor: pointer;
      text-align: center;
      border-top: 1px solid var(--border-light);
    }
    
    .toggle-controls:hover {
      background: var(--surface);
    }
    
    #mapwrap {
      height: calc(100vh - 120px);
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      position: relative;
      overflow: hidden;
    }
    
    #status {
      color: var(--error);
      margin-left: 12px;
      font-weight: 500;
      font-size: 0.875rem;
    }
    
    body { overflow-y: auto; }
    
    svg {
      width: 100%;
      height: 100%;
      background: transparent;
      display: block;
    }
    
    .ac {
      stroke: #ffffff;
      stroke-width: 0.5;
    }
    
    .ac:hover {
      stroke-width: 1;
      cursor: pointer;
    }
    
    .selected {
      stroke: var(--primary);
      stroke-width: 1.5;
    }
    
    .dimmed {
      opacity: 0.3;
      transition: opacity 0.3s ease;
    }
    
    #info {
      font-size: 0.95rem;
      font-weight: 500;
      color: var(--text-primary);
    }
    
    .label {
      font: 600 12px/1.1 system-ui, sans-serif;
      fill: var(--text-primary);
      paint-order: stroke;
      stroke: #fff;
      stroke-width: 3px;
      stroke-linejoin: round;
    }
    
    .legend {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    
    .legitem {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      border-radius: var(--radius-sm);
      font-size: 0.875rem;
      font-weight: 500;
      transition: var(--transition);
    }
    
    .swatch {
      width: 16px;
      height: 16px;
      border-radius: 3px;
      border: 1px solid var(--border);
    }
    
    .hover-outline {
      fill: none;
      stroke: var(--primary);
      stroke-width: 2;
      pointer-events: none;
    }
    
    .legend .legitem.active {
      background: var(--primary);
      color: white;
      border-radius: var(--radius-sm);
    }
    
    .tooltip {
      position: fixed;
      pointer-events: none;
      background: var(--surface-elevated);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 12px 16px;
      font-size: 0.875rem;
      box-shadow: var(--shadow-lg);
      display: none;
      max-width: 300px;
      backdrop-filter: blur(8px);
      z-index: 1000;
    }
    
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0,0,0,0);
      border: 0;
    }
    
    /* Floating Controls */
    .floating-controls {
      position: absolute;
      top: 16px;
      right: 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      z-index: var(--z-floating);
    }
    
    .floating-btn {
      width: var(--touch-target);
      height: var(--touch-target);
      background: var(--surface-elevated);
      border: 1px solid var(--border);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 18px;
      font-weight: 600;
      user-select: none;
    }
    
    .floating-btn:hover {
      background: var(--surface);
    }
    
    /* Bottom Sheet */
    .bottom-sheet {
      position: absolute;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--surface-elevated);
      border-top: 1px solid var(--border);
      border-top-left-radius: 16px;
      border-top-right-radius: 16px;
      transform: translateY(100%);
      transition: transform 0.3s ease;
      z-index: var(--z-modal);
      max-height: 50vh;
      overflow-y: auto;
    }
    
    .bottom-sheet.open {
      transform: translateY(0);
    }
    
    .bottom-sheet-handle {
      width: 40px;
      height: 4px;
      background: var(--border);
      border-radius: 2px;
      margin: 12px auto 16px;
    }
    
    .bottom-sheet-content {
      padding: 0 20px 20px;
    }
    
    .constituency-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 8px;
    }
    
    .constituency-details {
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-bottom: 16px;
      line-height: 1.5;
    }
    
    .detail-actions {
      display: flex;
      gap: 12px;
    }
    
    .btn-primary {
      background: var(--primary);
      color: white;
      padding: 12px 20px;
      border: none;
      border-radius: var(--radius);
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition);
      flex: 1;
    }
    
    .btn-primary:hover {
      background: var(--primary-hover);
    }
    
    .btn-secondary {
      background: transparent;
      color: var(--text-secondary);
      padding: 12px 20px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition);
    }
    
    .btn-secondary:hover {
      background: var(--surface);
    }
    
    /* Touch device optimizations */
    .touch-device .ac:hover {
      stroke-width: 0.5; /* Disable hover effects on touch */
    }
    
    /* Mobile Optimizations */
    @media (max-width: 768px) {
      #controls {
        padding: 10px 12px;
      }
      
      #mapwrap {
        height: calc(100vh - 100px);
      }
      
      .floating-controls {
        top: 12px;
        right: 12px;
        gap: 6px;
      }
      
      .floating-btn {
        width: 40px;
        height: 40px;
        font-size: 16px;
      }
      
      .search-input {
        font-size: 16px; /* Prevents zoom on iOS */
        padding: 14px 16px;
      }
      
      .bottom-sheet {
        max-height: 60vh;
      }
      
      .bottom-sheet-content {
        padding: 0 16px 16px;
      }
      
      .constituency-title {
        font-size: 1.125rem;
      }
      
      .btn-primary, .btn-secondary {
        padding: 14px 16px;
        font-size: 0.9rem;
      }
    }
    
    @media (max-width: 480px) {
      .detail-actions {
        flex-direction: column;
      }
      
      .btn-primary, .btn-secondary {
        flex: none;
      }
    }
    
    /* Tablet Optimizations */
    @media (min-width: 769px) and (max-width: 1024px) {
      .controls-secondary {
        display: flex !important;
        justify-content: center;
      }
      
      .toggle-controls {
        display: none;
      }
      
      #controls {
        padding: 14px 18px;
      }
      
      .floating-controls {
        top: 20px;
        right: 20px;
      }
    }
    
    /* Desktop Optimizations */
    @media (min-width: 1025px) {
      .controls-secondary {
        display: flex !important;
        justify-content: center;
      }
      
      .toggle-controls {
        display: none;
      }
      
      #controls {
        padding: 16px 24px;
      }
      
      .search-container {
        max-width: 400px;
      }
      
      .bottom-sheet {
        max-height: 40vh;
      }
    }
  </style>
</head>
<body>
  <div id="controls">
    <div class="search-container">
      <input id="searchAC" type="search" placeholder="Search constituencies..." list="acList" class="search-input" autocomplete="off" />
      <datalist id="acList"></datalist>
    </div>
    
    <div class="toggle-controls" id="toggleControls">
      ▲ Show Legend
    </div>
    
    <div class="controls-secondary" id="controlsSecondary">
      <span id="legend" class="legend"></span>
    </div>
    
    <select id="acSelect" style="display:none"><option value="">- Select -</option></select>
    <span id="status"></span>
    <div id="info" style="display:none"></div>
    <div id="announcer" class="sr-only" role="status" aria-live="polite"></div>
  </div>
  <div id="mapwrap" class="loading">
    <svg id="svg" viewBox="0 0 1200 900" preserveAspectRatio="xMidYMid meet">
      <g id="zoomlayer"></g>
      <g id="uiLayer"></g>
    </svg>
    
    <div class="floating-controls">
      <button id="zoomIn" type="button" class="floating-btn" title="Zoom in">+</button>
      <button id="zoomOut" type="button" class="floating-btn" title="Zoom out">−</button>
    </div>
    
    <div id="bottomSheet" class="bottom-sheet" aria-live="polite">
      <div class="bottom-sheet-handle"></div>
      <div class="bottom-sheet-content">
        <div id="constituencyTitle" class="constituency-title"></div>
        <div id="constituencyDetails" class="constituency-details"></div>
        <div class="detail-actions">
          <button id="moreDetails" class="btn-primary">More Details</button>
          <button id="clearSelection" class="btn-secondary">Clear</button>
        </div>
      </div>
    </div>
  </div>
  <div id="details" style="display:none;"></div>

  <div id="tooltip" class="tooltip"></div>

  <script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/topojson-client@3/dist/topojson-client.min.js"></script>
  <script>
    const width = 1200, height = 900;
    const svg = d3.select('#svg');
    const g = d3.select('#zoomlayer');
    const ui = d3.select('#uiLayer');
    const labelLayer = g.append('g').attr('id','labelLayer');
    const hoverLayer = g.append('path').attr('class','hover-outline').style('display','none');
    const statusEl = document.getElementById('status');
    const infoEl = document.getElementById('info');
    const selEl = document.getElementById('acSelect');
    const wrapEl = document.getElementById('mapwrap');
    const tooltip = document.getElementById('tooltip');
    let labelToKey = new Map();

    let biharData = null;
    let projection, path;
    let selectedId = null;
    let dataMap = new Map();
    let currentMetric = 'alliance';
    let classification = 'threshold';
    let breaks = [2000,5000,10000,20000,40000];
    
    // UI Elements
    const searchEl = document.getElementById('searchAC');
    const dataListEl = document.getElementById('acList');
    const bottomSheet = document.getElementById('bottomSheet');
    const constituencyTitle = document.getElementById('constituencyTitle');
    const constituencyDetails = document.getElementById('constituencyDetails');
    const toggleControls = document.getElementById('toggleControls');
    const controlsSecondary = document.getElementById('controlsSecondary');
    const clearSelectionBtn = document.getElementById('clearSelection');
    const moreDetailsBtn = document.getElementById('moreDetails');

    let allianceColors = new Map();
    let partiesData = new Map();
    const zoom = d3.zoom().scaleExtent([1, 20]).on('zoom', (ev) => { g.attr('transform', ev.transform); }).on('end', ()=>{ pushURLState(); });
    svg.call(zoom); svg.node().tabIndex = 0;

    // Indian locale formatting
    const inLocale = d3.formatLocale({ decimal: ".", thousands: ",", grouping: [3,2], currency: ["₹", ""], percent: "%" });
    const fmtInt = (v)=> v==null || isNaN(v) ? 'NA' : inLocale.format(",")(v);

    const metrics = {
      alliance: { id:'alliance', type:'category', get:(r)=> (r.current_mla_alliance||'').toUpperCase() },
      margin20: { id:'margin20', type:'numeric', get:(r)=> num(r.y2020_margin) },
      margin15: { id:'margin15', type:'numeric', get:(r)=> num(r.y2015_margin) },
      margin10: { id:'margin10', type:'numeric', get:(r)=> num(r.y2010_margin) }
    };

    function num(x){ if(x==null) return null; const s=String(x).replace(/,/g,'').trim(); const v=+s; return isFinite(v)?v:null; }
    function featureKey(p){ const n = p.AC_NO ?? p.ac_no ?? p.Ac_No; try { return String(parseInt(+n)).padStart(3,'0'); } catch { return String(n||''); } }
    function keyPad(n){ try { return String(parseInt(+n)).padStart(3,'0'); } catch { return String(n||''); } }
    function getCurrentMetric(){ return metrics[document.getElementById('metricSelect').value] || metrics.alliance; }

    function computeScale(values){
      const m = getCurrentMetric();
      if(m.type==='category') return null;
      const clean = values.filter(v=> v!=null && isFinite(v));
      const colors = ['#f2f0f7','#dadaeb','#bcbddc','#9e9ac8','#756bb1','#54278f'];
      if(classification==='quantile'){
        return { type:'quantile', scale: d3.scaleQuantile().domain(clean).range(colors) };
      } else if(classification==='quantize'){
        const min = d3.min(clean)||0, max = d3.max(clean)||1; return { type:'quantize', scale: d3.scaleQuantize().domain([min,max]).range(colors) };
      } else if(classification==='sequential'){
        const min = d3.min(clean)||0, max = d3.max(clean)||1; return { type:'sequential', scale: d3.scaleSequential().domain([min,max]).interpolator(d3.interpolatePuRd) };
      } else {
        return { type:'threshold', scale: d3.scaleThreshold().domain(breaks).range(colors) };
      }
    }

    function computeValueMap(){
      const m = getCurrentMetric(); if(m.type==='category') return null; const vals = [];
      for(const [k,row] of dataMap){ const v = m.get(row); if(v!=null && isFinite(v)) vals.push(v); }
      return computeScale(vals);
    }

    function getNumericValues(){
      const m = getCurrentMetric(); if(m.type==='category') return [];
      const vals = [];
      for(const [k,row] of dataMap){ const v = m.get(row); if(v!=null && isFinite(v)) vals.push(v); }
      return vals;
    }

    function debounce(fn, wait=25){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), wait); }; }

    function binIndex(spec, v){
      if(!spec) return -1;
      if(spec.type==='threshold'){
        const dom = spec.scale.domain();
        for(let i=0;i<dom.length;i++){ if(v<=dom[i]) return i; }
        return spec.scale.range().length-1;
      }
      if(spec.type==='quantize' || spec.type==='quantile'){
        const color = spec.scale(v);
        return spec.scale.range().indexOf(color);
      }
      return -1;
    }

    function populateSelect(features){
      const items = features.map(f => ({
        key: featureKey(f.properties),
        name: f.properties.AC_NAME || f.properties.ac_name || f.properties.Ac_Name || 'AC',
        dist: f.properties.DIST_NAME || f.properties.dist_name || ''
      })).sort((a,b) => a.key.localeCompare(b.key));
      for(const it of items){
        const label = `${it.key} - ${it.name}${it.dist? ' ('+it.dist+')':''}`;
        const opt = document.createElement('option'); opt.value = it.key; opt.textContent = label; selEl.appendChild(opt);
        if(dataListEl){ const dop = document.createElement('option'); dop.value = label; dataListEl.appendChild(dop); }
        labelToKey.set(label, it.key);
      }
    }

    function draw(features){
      g.selectAll('path').data(features).join('path')
        .attr('class', 'ac')
        .attr('data-key', d => featureKey(d.properties))
        .attr('d', d => path(d))
        .attr('fill', d => colorForFeature(d))
        .on('pointermove', handleHover)
        .on('pointerleave', clearHover)
        .on('click', (ev, d) => { selectByKey(featureKey(d.properties)); sanitizeSeparators(); });
    }
    
    function sanitizeSeparators(){
      if(infoEl) infoEl.innerHTML = infoEl.innerHTML.replace(' ? ', ' &middot; ');
      const detEl = document.getElementById('details');
      if(detEl) detEl.innerHTML = detEl.innerHTML.replace(' ? ', ' &middot; ');
    }

    function fitToFeature(f){
      const b = path.bounds(f); const dx = b[1][0]-b[0][0]; const dy = b[1][1]-b[0][1];
      const cx=(b[0][0]+b[1][0])/2, cy=(b[0][1]+b[1][1])/2; const scale=Math.max(1, 0.9/Math.max(dx/width, dy/height));
      const transform = d3.zoomIdentity.translate(width/2, height/2).scale(scale).translate(-cx, -cy);
      svg.transition().duration(750).call(zoom.transform, transform);
    }


    function setInfo(html){ infoEl.innerHTML = html || ''; }

    // Hover helpers (re-add with touch suppression)
    function clearLegendActive(){ document.querySelectorAll('#legend .legitem.active').forEach(n=> n.classList.remove('active')); }
    function highlightLegendForFeature(f){
      const m = getCurrentMetric(); const el = document.getElementById('legend'); if(!el) return; clearLegendActive();
      const k = featureKey(f.properties); const row = dataMap.get(k); if(!row) return;
      if(m.type==='category'){
        const a = (m.get(row)||'').toUpperCase(); const n = el.querySelector(`.legitem[data-lab="${a}"]`); if(n) n.classList.add('active');
      } else {
        const v = m.get(row); if(v==null || !isFinite(v)) return; const spec = computeValueMap();
        const color = spec.scale(v); const idx = spec.scale.range().indexOf(color);
        if(idx>=0){ const n = el.querySelector(`.legitem[data-bin="${idx}"]`); if(n) n.classList.add('active'); }
      }
    }
    const handleHover = debounce((ev, d)=>{ if(ev && ev.pointerType==='touch') return; showTooltip(ev,d); try{ hoverLayer.attr('d', path(d)).style('display','block'); }catch(e){} highlightLegendForFeature(d); }, 10);
    function clearHover(){ hideTooltip(); hoverLayer.style('display','none'); clearLegendActive(); }

    function colorForFeature(f){
      const k = featureKey(f.properties); const row = dataMap.get(k);
      if(!row) return '#cfe3f6';
      const m = getCurrentMetric();
      if(m.type==='category'){
        const a = (m.get(row)||'').toUpperCase(); return (allianceColors.get(a) || '#cccccc');
      } else {
        const v = m.get(row); if(v==null || !isFinite(v)) return '#eeeeee';
        const spec = computeValueMap();
        return spec.scale(v);
      }
    }

    function updateLegend(){
      const el = document.getElementById('legend'); el.innerHTML='';
      const m = getCurrentMetric();
      if(m.type==='category'){
        for(const [lab,col] of allianceColors){ 
          const wrap=document.createElement('span'); 
          wrap.className='legitem'; 
          wrap.dataset.lab=lab; 
          const box=document.createElement('span'); 
          box.className='swatch'; 
          box.style.background=col; 
          const t=document.createElement('span'); 
          t.textContent=lab; 
          t.style.marginRight='10px'; 
          wrap.appendChild(box); 
          wrap.appendChild(t); 
          el.appendChild(wrap);
        } 
        return;
      }
      const spec = computeValueMap();
      if(spec.type==='sequential'){
        const bar = document.createElement('div'); bar.className='gradient'; el.appendChild(bar);
        const values = Array.from(dataMap.values(), r => getCurrentMetric().get(r)).filter(v=>v!=null);
        const min = d3.min(values)||0, max = d3.max(values)||1;
        const lab = document.createElement('div'); lab.style.fontSize='12px'; lab.style.marginTop='4px'; lab.textContent = fmtInt(min) + ' - ' + fmtInt(max); el.appendChild(lab);
        return;
      }
      const rng = spec.scale.range();
      if(spec.type==='quantize'){
        for(let i=0;i<rng.length;i++){
          const color = rng[i]; const ext = spec.scale.invertExtent(color); const a = ext[0], b = ext[1];
          let label; if(i===0){ label = '<= ' + fmtInt(b); } else if(i===rng.length-1){ label = '>= ' + fmtInt(a); } else { label = fmtInt(a) + '-' + fmtInt(b); }
          const wrap=document.createElement('span'); wrap.className='legitem'; wrap.dataset.bin=String(i); const box=document.createElement('span'); box.className='swatch'; box.style.background=color; const t=document.createElement('span'); t.textContent = label; t.style.marginRight='8px'; wrap.appendChild(box); wrap.appendChild(t); el.appendChild(wrap);
        }
        return;
      }
      if(spec.type==='quantile'){
        const thresholds = spec.scale.quantiles(); const vals = getNumericValues(); const min = d3.min(vals)||0, max = d3.max(vals)||0; const bounds = [min, ...thresholds, max];
        for(let i=0;i<rng.length;i++){
          let label; if(i===0){ label = '<= ' + fmtInt(bounds[1]); } else if(i===rng.length-1){ label = '>= ' + fmtInt(bounds[bounds.length-2]); } else { label = fmtInt(bounds[i]) + '-' + fmtInt(bounds[i+1]); }
          const wrap=document.createElement('span'); wrap.className='legitem'; wrap.dataset.bin=String(i); const box=document.createElement('span'); box.className='swatch'; box.style.background=rng[i]; const t=document.createElement('span'); t.textContent = label; t.style.marginRight='8px'; wrap.appendChild(box); wrap.appendChild(t); el.appendChild(wrap);
        }
        return;
      }
      if(spec.type==='threshold'){
        const domain = spec.scale.domain();
        for(let i=0;i<rng.length;i++){
          let label; if(i===0){ label = '<= ' + fmtInt(domain[0]); } else if(i===rng.length-1){ label = '>= ' + fmtInt(domain[domain.length-1]); } else { label = fmtInt(domain[i-1]) + '-' + fmtInt(domain[i]); }
          const wrap=document.createElement('span'); wrap.className='legitem'; wrap.dataset.bin=String(i); const box=document.createElement('span'); box.className='swatch'; box.style.background=rng[i]; const t=document.createElement('span'); t.textContent = label; t.style.marginRight='8px'; wrap.appendChild(box); wrap.appendChild(t); el.appendChild(wrap);
        }
        return;
      }
    }

    function clearSelection(){
      selectedId = null;
      g.selectAll('path').classed('selected', false).classed('dimmed', false);
      labelLayer.selectAll('text.sel').remove();
      setInfo('');
      document.getElementById('details').innerHTML = '';
      selEl.value = '';
      if(searchEl) searchEl.value = '';
      
      // Close bottom sheet
      if(bottomSheet) bottomSheet.classList.remove('open');
      
      svg.transition().duration(400).call(zoom.transform, d3.zoomIdentity);
      pushURLState();
    }

    function selectByKey(key){
      selectedId = key;
      g.selectAll('path')
        .classed('selected', d => featureKey(d.properties) === key)
        .classed('dimmed', d => featureKey(d.properties) !== key);
      g.selectAll('path').filter(d => featureKey(d.properties) === key).raise();
      
      const f = biharData.features.find(ft => featureKey(ft.properties) === key);
      if(f){
        fitToFeature(f);
        const p = f.properties; 
        const acname = p.AC_NAME || p.ac_name || p.Ac_Name || ''; 
        const dist = p.DIST_NAME || p.dist_name || '';
        const row = dataMap.get(key) || {};
        
        // Update announcer for accessibility
        document.getElementById('announcer').textContent = `Selected ${key} ${acname}`;
        
        // Update bottom sheet
        if(constituencyTitle) {
          constituencyTitle.textContent = `${key} • ${acname}`;
        }
        
        if(constituencyDetails) {
          let details = [];
          if(dist) details.push(`District: ${dist}`);
          if(row.reserved) details.push(`Category: ${row.reserved}`);
          if(row.current_mla_name) {
            const party = row.current_mla_party || '';
            const alliance = row.current_mla_alliance || '';
            details.push(`Current MLA: ${row.current_mla_name}`);
            if(party) details.push(`Party: ${party}`);
            if(alliance) details.push(`Alliance: ${alliance}`);
          }
          if(row.y2020_margin) {
            details.push(`2020 Margin: ${fmtInt(num(row.y2020_margin))} votes`);
          }
          constituencyDetails.innerHTML = details.join('<br>');
        }
        
        // Update more details link
        if(moreDetailsBtn && row.slug) {
          moreDetailsBtn.onclick = () => window.open(`/bihar/constituency/${row.slug}`, '_blank');
        }
        
        // Show bottom sheet
        if(bottomSheet) bottomSheet.classList.add('open');
        
        pushURLState();
      }
    }

    function showTooltip(ev, d){
      const p = d.properties || {}; const k = featureKey(p); const row = dataMap.get(k) || {}; const name = p.AC_NAME || p.ac_name || p.Ac_Name || ''; const dist = p.DIST_NAME || p.dist_name || '';
      const m = getCurrentMetric(); let line='';
      if(m.type==='category'){ line = 'Alliance: ' + (row.current_mla_alliance || ''); }
      else if(m.id==='margin20'){ line = '2020 margin: ' + fmtInt(m.get(row)); }
      else if(m.id==='margin15'){ line = '2015 margin: ' + fmtInt(m.get(row)); }
      else if(m.id==='margin10'){ line = '2010 margin: ' + fmtInt(m.get(row)); }
      tooltip.innerHTML = `<b>${k} ${name}</b>${dist? ' &middot; '+dist:''}<br>${line}`; tooltip.style.display='block'; tooltip.style.left=(ev.clientX+12)+'px'; tooltip.style.top=(ev.clientY+12)+'px';
    }
    function hideTooltip(){ tooltip.style.display='none'; }

    function recolor(){ g.selectAll('path.ac').attr('fill', d => colorForFeature(d)); }
    function updateLegendAndRecolor(){ updateLegend(); recolor(); }


    function applyViewFromURL(){
      const q = new URLSearchParams(location.search);
      const ac = q.get('ac'); if(ac) { selectedId = ac; }
      const k = parseFloat(q.get('k')), x = parseFloat(q.get('x')), y = parseFloat(q.get('y'));
      if(!isNaN(k) && !isNaN(x) && !isNaN(y)){
        const t = d3.zoomIdentity.translate(x,y).scale(k); svg.call(zoom.transform, t);
      }
    }

    function pushURLState(){
      const t = d3.zoomTransform(svg.node());
      const params = new URLSearchParams(location.search);
      if(selectedId) params.set('ac', selectedId); else params.delete('ac');
      params.set('k', (+t.k).toFixed(3)); params.set('x', (+t.x).toFixed(0)); params.set('y', (+t.y).toFixed(0));
      history.replaceState(null,'', location.pathname + '?' + params.toString());
    }

    function initializeUI() {
      // Toggle controls
      if(toggleControls) {
        toggleControls.addEventListener('click', () => {
          const isOpen = controlsSecondary.style.display !== 'none';
          controlsSecondary.style.display = isOpen ? 'none' : 'flex';
          toggleControls.innerHTML = isOpen ? '▲ Show Legend' : '▼ Hide Legend';
        });
      }
      
      // Clear selection
      if(clearSelectionBtn) {
        clearSelectionBtn.addEventListener('click', clearSelection);
      }
      
      // Search functionality
      if(searchEl) {
        searchEl.addEventListener('input', handleSearch);
        searchEl.addEventListener('change', handleSearchSelect);
      }
    }
    
    function handleSearch() {
      const query = (searchEl.value || '').trim().toLowerCase();
      
      g.selectAll('path').classed('dimmed', d => {
        if(selectedId) return featureKey(d.properties) !== selectedId;
        if(!query) return false;
        
        const p = d.properties || {};
        const key = featureKey(p);
        const name = (p.AC_NAME || p.ac_name || p.Ac_Name || '').toLowerCase();
        const dist = (p.DIST_NAME || p.dist_name || '').toLowerCase();
        
        return !(key.includes(query) || name.includes(query) || dist.includes(query));
      });
    }
    
    function handleSearchSelect() {
      const value = searchEl.value;
      const key = labelToKey.get(value);
      if(key) {
        selectByKey(key);
      }
    }
    
    // Events
    selEl.addEventListener('change', (e)=>{ const v = e.target.value; if(v) { selectByKey(v); } else { clearSelection(); } });

    // Touch gesture support for mobile
    function addTouchSupport() {
      // Optimize for touch devices
      if ('ontouchstart' in window) {
        document.body.classList.add('touch-device');
      }
    }
    
    // Search is now handled in initializeUI()
    document.getElementById('zoomIn').addEventListener('click', ()=> svg.transition().duration(300).call(zoom.scaleBy, 1.3));
    document.getElementById('zoomOut').addEventListener('click', ()=> svg.transition().duration(300).call(zoom.scaleBy, 1/1.3));
    svg.on('keydown', (e)=>{ if(e.key==='+'){ svg.transition().duration(300).call(zoom.scaleBy,1.3);} else if(e.key==='-'){ svg.transition().duration(300).call(zoom.scaleBy,1/1.3);} else if(e.key==='0'){ svg.transition().duration(400).call(zoom.transform,d3.zoomIdentity);} });

    let closeIcon;
    function buildCloseIcon(){
      const posX = width - 28, posY = 28; // top-right in viewBox
      closeIcon = ui.append('g')
        .attr('id','closeIcon')
        .attr('transform', `translate(${posX}, ${posY})`)
        .style('display','none')
        .style('cursor','pointer')
        .attr('role','button')
        .attr('tabindex', 0)
        .attr('aria-label','Reset view');
      closeIcon.append('circle').attr('r', 12).attr('fill', '#ffffff').attr('stroke', '#666');
      closeIcon.append('line').attr('x1', -5).attr('y1', -5).attr('x2', 5).attr('y2', 5).attr('stroke', '#333').attr('stroke-width', 2).attr('stroke-linecap', 'round');
      closeIcon.append('line').attr('x1', 5).attr('y1', -5).attr('x2', -5).attr('y2', 5).attr('stroke', '#333').attr('stroke-width', 2).attr('stroke-linecap', 'round');
      closeIcon.on('click', clearSelection);
      closeIcon.on('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ clearSelection(); } });

      // Zoom FABs stacked under reset icon
      const zoomIn = ui.append('g').attr('transform', `translate(${width - 28}, ${28+36})`).style('cursor','pointer');
      zoomIn.append('circle').attr('r', 12).attr('fill', '#ffffff').attr('stroke', '#666');
      zoomIn.append('text').attr('text-anchor','middle').attr('dy','0.35em').attr('font-size','14px').text('+');
      zoomIn.on('click', ()=> svg.transition().duration(250).call(zoom.scaleBy, 1.3));

      const zoomOut = ui.append('g').attr('transform', `translate(${width - 28}, ${28+36+36})`).style('cursor','pointer');
      zoomOut.append('circle').attr('r', 12).attr('fill', '#ffffff').attr('stroke', '#666');
      zoomOut.append('text').attr('text-anchor','middle').attr('dy','0.35em').attr('font-size','16px').text('−');
      zoomOut.on('click', ()=> svg.transition().duration(250).call(zoom.scaleBy, 1/1.3));
    }
    function updateCloseBtn(){ const k = d3.zoomTransform(svg.node()).k; const show = (k>1.01 || selectedId); if(closeIcon) closeIcon.style('display', show ? 'block' : 'none'); }

    async function loadBoundaries(){
      try {
        const rTopo = await fetch('bihar_ac_all.topojson');
        if(rTopo.ok){
          const topo = await rTopo.json();
          const objName = topo.objects && Object.keys(topo.objects)[0];
          if(objName){
            const fc = topojson.feature(topo, topo.objects[objName]);
            return fc;
          }
        }
      } catch (e) { /* fall back to GeoJSON */ }
      return await fetch('bihar_ac_all.geojson').then(r => r.json());
    }

    async function loadParties(){
      try {
        const response = await fetch('parties.json');
        const parties = await response.json();
        
        // Create alliance color map
        const allianceMap = {};
        parties.forEach(party => {
          partiesData.set(party.code, party);
          if (!allianceMap[party.alliance]) {
            // Assign colors based on alliance
            switch(party.alliance) {
              case 'NDA': allianceMap[party.alliance] = '#ff9933'; break;
              case 'MGB': allianceMap[party.alliance] = '#3399ff'; break;
              case 'OTH': allianceMap[party.alliance] = '#009933'; break;
              case 'NA': allianceMap[party.alliance] = '#999999'; break;
              default: allianceMap[party.alliance] = '#cccccc';
            }
          }
        });
        
        allianceColors = new Map(Object.entries(allianceMap));
        return true;
      } catch(e) {
        console.warn('Failed to load parties.json, using default colors');
        allianceColors = new Map(Object.entries({ 
          NDA: '#ff9933', 
          MGB: '#3399ff', 
          OTH: '#009933', 
          IND: '#999999',
          NA: '#999999'
        }));
        return false;
      }
    }
    
    async function init(){
      try{
        statusEl.textContent = 'Loading...';
        
        // Load parties data first
        await loadParties();
        
        // Load boundaries
        const data = await loadBoundaries();
        biharData = data; 
        projection = d3.geoMercator().fitSize([width, height], biharData); 
        path = d3.geoPath(projection);
        
        draw(biharData.features); 
        populateSelect(biharData.features); 
        wrapEl.classList.remove('loading'); 
        statusEl.textContent='';
        
        // Load election data
        try{ 
          const rows = await d3.csv('bihar_election_results_consolidated.csv'); 
          dataMap = new Map(rows.map(r => [ keyPad(r.no), r ])); 
          updateLegendAndRecolor(); 
        } catch(e){ console.warn('CSV load failed', e); }
        
        // Initialize UI
        initializeUI();
        addTouchSupport();
        applyViewFromURL(); 
        if(selectedId){ selectByKey(selectedId); }
        
      }catch(e){ 
        console.error(e); 
        statusEl.textContent = 'Failed to load data'; 
      }
    }

    init();
  </script>
</body>
</html>



















