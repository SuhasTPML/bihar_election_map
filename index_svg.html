<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bihar Assembly Constituencies — SVG Choropleth</title>
  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, Arial, sans-serif; }
    #controls { padding: 10px 12px; display:flex; gap:10px; align-items:center; flex-wrap: wrap; border-bottom: 1px solid #eee; }
    #mapwrap { height: calc(100vh - 86px); }
    #status { color: #b00; margin-left: 8px; }
    svg { width: 100%; height: 100%; background: #f9fafb; display:block; }
    .ac { stroke: #1f77b4; stroke-width: 0.5; }
    .ac:hover { stroke-width: 0.8; cursor: pointer; }
    .selected { stroke: #d62728; stroke-width: 1.2; }
    #info { font-size: 0.95rem; }
    .label { font: 12px/1.1 sans-serif; fill: #111; paint-order: stroke; stroke: #fff; stroke-width: 3px; stroke-linejoin: round; }
    .legend { display:flex; align-items:center; gap:8px; }
    .legend .swatch { width:14px; height:14px; border:1px solid #999; }
    .legend .gradient { width: 220px; height: 12px; border:1px solid #999; background: linear-gradient(90deg,#f2f0f7,#dadaeb,#bcbddc,#9e9ac8,#756bb1,#54278f); }
    .tooltip { position: fixed; pointer-events: none; background: rgba(255,255,255,0.95); border: 1px solid #ccc; border-radius: 4px; padding: 6px 8px; font-size: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.2); display:none; }
    .sr-only { position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0; }
  </style>
</head>
<body>
  <div id="controls">
    <strong>Bihar Assembly (SVG)</strong>
    <label for="acSelect">AC:</label>
    <select id="acSelect"><option value="">- Select -</option></select>
    <label for="searchBox">Search:</label>
    <input id="searchBox" type="text" placeholder="AC no or name" style="width:200px"/>
    <button id="searchGo" type="button">Go</button>
    <button id="clearSel" type="button">Clear</button>
    <button id="zoomOut" type="button" title="Zoom out">-</button>
    <button id="zoomIn" type="button" title="Zoom in">+</button>
    <button id="resetView" type="button" title="Reset view">Reset</button>
    <label for="metricSelect">Color by:</label>
    <select id="metricSelect">
      <option value="alliance" selected>Alliance (current)</option>
      <option value="margin20">Margin (2020)</option>
      <option value="margin15">Margin (2015)</option>
      <option value="margin10">Margin (2010)</option>
    </select>
    <label for="classifySelect">Classify:</label>
    <select id="classifySelect">
      <option value="threshold" selected>Threshold</option>
      <option value="quantile">Quantile</option>
      <option value="quantize">Quantize</option>
      <option value="sequential">Sequential</option>
    </select>
    <span id="legend" class="legend"></span>
    <button id="copyView" type="button">Copy View</button>
    <span id="status"></span>
    <div id="info"></div>
    <div id="announcer" class="sr-only" role="status" aria-live="polite"></div>
  </div>
  <div id="mapwrap" class="loading">
    <svg id="svg" viewBox="0 0 1200 900" preserveAspectRatio="xMidYMid meet">
      <g id="zoomlayer"></g>
    </svg>
  </div>
  <div id="tooltip" class="tooltip"></div>

  <script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>
  <script>
    const width = 1200, height = 900;
    const svg = d3.select('#svg');
    const g = d3.select('#zoomlayer');
    const labelLayer = g.append('g').attr('id','labelLayer');
    const statusEl = document.getElementById('status');
    const infoEl = document.getElementById('info');
    const selEl = document.getElementById('acSelect');
    const wrapEl = document.getElementById('mapwrap');
    const tooltip = document.getElementById('tooltip');

    let biharData = null;
    let projection, path;
    let selectedId = null;
    let dataMap = new Map();
    let currentMetric = 'alliance';
    let classification = 'threshold';
    let breaks = [2000,5000,10000,20000,40000];

    const allianceColors = new Map(Object.entries({ NDA: '#1f77b4', MGB: '#d62728', UPA: '#9467bd', OTH: '#8c564b', IND: '#7f7f7f' }));
    const zoom = d3.zoom().scaleExtent([1, 20]).on('zoom', (ev) => { g.attr('transform', ev.transform); }).on('end', pushURLState);
    svg.call(zoom); svg.node().tabIndex = 0;

    // Indian locale formatting
    const inLocale = d3.formatLocale({ decimal: ".", thousands: ",", grouping: [3,2], currency: ["₹", ""], percent: "%" });
    const fmtInt = (v)=> v==null || isNaN(v) ? 'NA' : inLocale.format(",")(v);

    const metrics = {
      alliance: { id:'alliance', type:'category', get:(r)=> (r.current_mla_alliance||'').toUpperCase(), palette: allianceColors },
      margin20: { id:'margin20', type:'numeric', get:(r)=> num(r.y2020_margin) },
      margin15: { id:'margin15', type:'numeric', get:(r)=> num(r.y2015_margin) },
      margin10: { id:'margin10', type:'numeric', get:(r)=> num(r.y2010_margin) }
    };

    function num(x){ if(x==null) return null; const s=String(x).replace(/,/g,'').trim(); const v=+s; return isFinite(v)?v:null; }
    function featureKey(p){ const n = p.AC_NO ?? p.ac_no ?? p.Ac_No; try { return String(parseInt(+n)).padStart(3,'0'); } catch { return String(n||''); } }
    function keyPad(n){ try { return String(parseInt(+n)).padStart(3,'0'); } catch { return String(n||''); } }
    function getCurrentMetric(){ return metrics[document.getElementById('metricSelect').value] || metrics.alliance; }

    function computeScale(values){
      const m = getCurrentMetric();
      if(m.type==='category') return null;
      const clean = values.filter(v=> v!=null && isFinite(v));
      const colors = ['#f2f0f7','#dadaeb','#bcbddc','#9e9ac8','#756bb1','#54278f'];
      if(classification==='quantile'){
        return { type:'quantile', scale: d3.scaleQuantile().domain(clean).range(colors) };
      } else if(classification==='quantize'){
        const min = d3.min(clean)||0, max = d3.max(clean)||1; return { type:'quantize', scale: d3.scaleQuantize().domain([min,max]).range(colors) };
      } else if(classification==='sequential'){
        const min = d3.min(clean)||0, max = d3.max(clean)||1; return { type:'sequential', scale: d3.scaleSequential().domain([min,max]).interpolator(d3.interpolatePuRd) };
      } else {
        return { type:'threshold', scale: d3.scaleThreshold().domain(breaks).range(colors) };
      }
    }

    function computeValueMap(){
      const m = getCurrentMetric(); if(m.type==='category') return null; const vals = [];
      for(const [k,row] of dataMap){ const v = m.get(row); if(v!=null && isFinite(v)) vals.push(v); }
      return computeScale(vals);
    }

    function colorForFeature(f){
      const k = featureKey(f.properties); const row = dataMap.get(k);
      if(!row) return '#cfe3f6';
      const m = getCurrentMetric();
      if(m.type==='category'){
        const a = (m.get(row)||'').toUpperCase(); return (metrics.alliance.palette.get(a) || '#cccccc');
      } else {
        const v = m.get(row); if(v==null || !isFinite(v)) return '#eeeeee';
        const spec = computeValueMap();
        return spec.type==='sequential' ? spec.scale(v) : spec.scale(v);
      }
    }

    function updateLegend(){
      const el = document.getElementById('legend'); el.innerHTML='';
      const m = getCurrentMetric();
      if(m.type==='category'){
        for(const [lab,col] of allianceColors){ const box=document.createElement('span'); box.className='swatch'; box.style.background=col; const t=document.createElement('span'); t.textContent=lab; t.style.marginRight='10px'; el.appendChild(box); el.appendChild(t);} return; }
      const spec = computeValueMap();
      if(spec.type==='sequential'){
        const bar = document.createElement('div'); bar.className='gradient'; el.appendChild(bar);
        const values = Array.from(dataMap.values(), r => getCurrentMetric().get(r)).filter(v=>v!=null);
        const min = d3.min(values)||0, max = d3.max(values)||1;
        const lab = document.createElement('div'); lab.style.fontSize='12px'; lab.style.marginTop='4px'; lab.textContent = fmtInt(min) + ' — ' + fmtInt(max); el.appendChild(lab);
        return;
      }
      const domain = spec.scale.domain(); const rng = spec.scale.range();
      for(let i=0;i<rng.length;i++){
        const box=document.createElement('span'); box.className='swatch'; box.style.background=rng[i];
        const from = i===0? 0 : domain[i-1]; const to = domain[i];
        const t=document.createElement('span'); t.textContent = (to? (fmtInt(from)+'–'+fmtInt(to)) : (fmtInt(from)+'+')); t.style.marginRight='8px';
        el.appendChild(box); el.appendChild(t);
      }
    }

    function populateSelect(features){
      const items = features.map(f => ({
        key: featureKey(f.properties),
        name: f.properties.AC_NAME || f.properties.ac_name || f.properties.Ac_Name || 'AC',
        dist: f.properties.DIST_NAME || f.properties.dist_name || ''
      })).sort((a,b) => a.key.localeCompare(b.key));
      for(const it of items){ const opt = document.createElement('option'); opt.value = it.key; opt.textContent = `${it.key} - ${it.name}${it.dist? ' ('+it.dist+')':''}`; selEl.appendChild(opt); }
    }

    function draw(features){
      g.selectAll('path').data(features).join('path')
        .attr('class', 'ac')
        .attr('data-key', d => featureKey(d.properties))
        .attr('d', d => path(d))
        .attr('fill', d => colorForFeature(d))
        .on('mousemove', (ev,d)=> showTooltip(ev,d))
        .on('mouseleave', hideTooltip)
        .on('click', (ev, d) => selectByKey(featureKey(d.properties)));
    }

    function fitToFeature(f){
      const b = path.bounds(f); const dx = b[1][0]-b[0][0]; const dy = b[1][1]-b[0][1];
      const cx=(b[0][0]+b[1][0])/2, cy=(b[0][1]+b[1][1])/2; const scale=Math.max(1, 0.9/Math.max(dx/width, dy/height));
      const transform = d3.zoomIdentity.translate(width/2, height/2).scale(scale).translate(-cx, -cy);
      svg.transition().duration(750).call(zoom.transform, transform);
    }

    function clearSelection(){
      selectedId = null; g.selectAll('path').classed('selected', false); selEl.value = '';
      setInfo(''); labelLayer.selectAll('*').remove(); hideTooltip(); pushURLState();
    }

    function setInfo(html){ infoEl.innerHTML = html || ''; }

    function selectByKey(key){
      selectedId = key; g.selectAll('path').classed('selected', d => featureKey(d.properties) === key);
      g.selectAll('path').filter(d => featureKey(d.properties) === key).raise();
      const f = biharData.features.find(ft => featureKey(ft.properties) === key);
      if(f){
        fitToFeature(f);
        const p = f.properties; const acname = p.AC_NAME || p.ac_name || p.Ac_Name || ''; const dist = p.DIST_NAME || p.dist_name || '';
        setInfo(`<b>${key} ${acname}</b>${dist? ' · District: '+dist:''}`);
        document.getElementById('announcer').textContent = `${key} ${acname}`;
        try { const c = path.centroid(f); labelLayer.raise(); labelLayer.selectAll('text.sel').data([f]).join('text').attr('class','label sel').attr('x', c[0]).attr('y', c[1]).attr('text-anchor','middle').text(key + ' ' + acname); } catch(e){}
        pushURLState();
      }
    }

    function showTooltip(ev, d){
      const p = d.properties || {}; const k = featureKey(p); const row = dataMap.get(k) || {}; const name = p.AC_NAME || p.ac_name || p.Ac_Name || ''; const dist = p.DIST_NAME || p.dist_name || '';
      const m = getCurrentMetric(); let line='';
      if(m.type==='category'){ line = 'Alliance: ' + (row.current_mla_alliance || ''); }
      else if(m.id==='margin20'){ line = '2020 margin: ' + fmtInt(m.get(row)); }
      else if(m.id==='margin15'){ line = '2015 margin: ' + fmtInt(m.get(row)); }
      else if(m.id==='margin10'){ line = '2010 margin: ' + fmtInt(m.get(row)); }
      tooltip.innerHTML = `<b>${k} ${name}</b>${dist? ' · '+dist:''}<br>${line}`; tooltip.style.display='block'; tooltip.style.left=(ev.clientX+12)+'px'; tooltip.style.top=(ev.clientY+12)+'px';
    }
    function hideTooltip(){ tooltip.style.display='none'; }

    function recolor(){ g.selectAll('path.ac').attr('fill', d => colorForFeature(d)); }
    function updateLegendAndRecolor(){ updateLegend(); recolor(); }

    function doSearch(){
      const q = document.getElementById('searchBox').value.trim().toLowerCase(); if(!q) return;
      const keyMatch = q.match(/^\d{1,3}$/) ? String(parseInt(q,10)).padStart(3,'0') : null;
      let key = keyMatch;
      if(!key){ const found = biharData.features.find(f => ((f.properties.AC_NAME||f.properties.ac_name||f.properties.Ac_Name||'').toLowerCase().includes(q))); if(found) key = featureKey(found.properties); }
      if(key) selectByKey(key);
    }

    function copyView(){
      const t = d3.zoomTransform(svg.node());
      const params = new URLSearchParams(location.search);
      params.set('metric', document.getElementById('metricSelect').value);
      if(selectedId) params.set('ac', selectedId); else params.delete('ac');
      params.set('k', (+t.k).toFixed(3)); params.set('x', (+t.x).toFixed(0)); params.set('y', (+t.y).toFixed(0));
      const url = location.origin + location.pathname + '?' + params.toString();
      if(navigator.clipboard) navigator.clipboard.writeText(url).then(()=> statusEl.textContent='Link copied').catch(()=>{});
      setTimeout(()=> statusEl.textContent='', 1500);
    }

    function applyViewFromURL(){
      const q = new URLSearchParams(location.search);
      const m = q.get('metric'); if(m && metrics[m]) { document.getElementById('metricSelect').value = m; currentMetric = m; }
      const ac = q.get('ac'); if(ac) { selectedId = ac; }
      const k = parseFloat(q.get('k')), x = parseFloat(q.get('x')), y = parseFloat(q.get('y'));
      if(!isNaN(k) && !isNaN(x) && !isNaN(y)){
        const t = d3.zoomIdentity.translate(x,y).scale(k); svg.call(zoom.transform, t);
      }
    }

    function pushURLState(){
      const t = d3.zoomTransform(svg.node());
      const params = new URLSearchParams(location.search);
      params.set('metric', document.getElementById('metricSelect').value);
      if(selectedId) params.set('ac', selectedId); else params.delete('ac');
      params.set('k', (+t.k).toFixed(3)); params.set('x', (+t.x).toFixed(0)); params.set('y', (+t.y).toFixed(0));
      history.replaceState(null,'', location.pathname + '?' + params.toString());
    }

    // Events
    document.getElementById('metricSelect').addEventListener('change', ()=> { currentMetric = document.getElementById('metricSelect').value; updateLegendAndRecolor(); pushURLState(); });
    document.getElementById('classifySelect').addEventListener('change', (e)=> { classification = e.target.value; updateLegendAndRecolor(); pushURLState(); });
    document.getElementById('searchGo').addEventListener('click', doSearch);
    document.getElementById('searchBox').addEventListener('keydown', (e)=> { if(e.key==='Enter'){ doSearch(); }});
    document.getElementById('clearSel').addEventListener('click', clearSelection);
    document.getElementById('zoomIn').addEventListener('click', ()=> svg.transition().duration(300).call(zoom.scaleBy, 1.3));
    document.getElementById('zoomOut').addEventListener('click', ()=> svg.transition().duration(300).call(zoom.scaleBy, 1/1.3));
    document.getElementById('resetView').addEventListener('click', ()=> svg.transition().duration(400).call(zoom.transform, d3.zoomIdentity));
    document.getElementById('copyView').addEventListener('click', copyView);
    svg.on('keydown', (e)=>{ if(e.key==='+'){ svg.transition().duration(300).call(zoom.scaleBy,1.3);} else if(e.key==='-'){ svg.transition().duration(300).call(zoom.scaleBy,1/1.3);} else if(e.key==='0'){ svg.transition().duration(400).call(zoom.transform,d3.zoomIdentity);} });

    async function init(){
      try{
        statusEl.textContent = 'Loading Bihar GeoJSON...';
        const data = await fetch('bihar_ac_all.geojson').then(r => r.json());
        biharData = data; projection = d3.geoMercator().fitSize([width, height], biharData); path = d3.geoPath(projection);
        draw(biharData.features); populateSelect(biharData.features); wrapEl.classList.remove('loading'); statusEl.textContent='';
        try{ const rows = await d3.csv('bihar_election_results_consolidated.csv'); dataMap = new Map(rows.map(r => [ keyPad(r.no), r ])); updateLegendAndRecolor(); } catch(e){ console.warn('CSV load failed', e); }
        applyViewFromURL(); if(selectedId){ selectByKey(selectedId); }
      }catch(e){ console.error(e); statusEl.textContent = 'Failed to load Bihar GeoJSON'; }
    }

    init();
  </script>
</body>
</html>